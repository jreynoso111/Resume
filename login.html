<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | Juan R. Reynoso</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/styles.css?v=33" />
  <style>
    .auth-wrap { max-width: 460px; margin: 48px auto 24px; }
    .auth-card { border: 1px solid var(--border-subtle); background: var(--bg-soft); border-radius: 14px; padding: 18px; box-shadow: var(--card-shadow); }
    .auth-title { margin: 0 0 8px; color: var(--accent-strong); font-size: 24px; }
    .auth-sub { margin: 0 0 14px; color: var(--text-muted); font-size: 13px; }
    .auth-field { display: grid; gap: 6px; margin-bottom: 10px; }
    .auth-field label { color: var(--text-muted); font-size: 12px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; }
    .auth-actions { display: grid; gap: 8px; margin-top: 12px; }
    .auth-error { margin-top: 10px; color: #b91c1c; font-size: 13px; min-height: 18px; }
    .auth-links { margin-top: 12px; font-size: 13px; color: var(--text-muted); }
    .btn-google { background: var(--chip-bg); color: var(--text-main); border: 1px solid var(--border-subtle); justify-content: center; }
    .auth-spacer { height: 24px; }
  </style>
</head>

<body>
  <div class="page">
    <header id="site-header" data-variant="home" data-active=""></header>

    <main id="top">
      <section class="hero">
        <div class="shell">
          <div class="auth-wrap">
            <article class="auth-card">
              <h1 class="auth-title">Login</h1>
              <p class="auth-sub">Sign in with your email and password or continue with Google.</p>

              <form id="login-form" novalidate>
                <div class="auth-field">
                  <label for="login-email">Email</label>
                  <input id="login-email" class="cc-input" type="email" autocomplete="email" required />
                </div>
                <div class="auth-field">
                  <label for="login-password">Password</label>
                  <input id="login-password" class="cc-input" type="password" autocomplete="current-password" required />
                </div>

                <div class="auth-actions">
                  <button id="login-submit" class="btn-primary" type="submit">Login</button>
                  <button id="google-login" class="btn-primary btn-google" type="button">Continue with Google</button>
                </div>
                <div id="login-error" class="auth-error" role="status" aria-live="polite"></div>
              </form>

              <div class="auth-links">
                Donâ€™t have an account? <a href="register.html" style="color: var(--accent-strong);">Create one</a>
              </div>
            </article>
          </div>
          <div class="auth-spacer"></div>
        </div>
      </section>
    </main>

    <footer id="site-footer" data-root-path=""></footer>
  </div>

  <script src="assets/js/auth.js?v=2"></script>
  <script>
    (function () {
      const form = document.getElementById('login-form');
      const emailInput = document.getElementById('login-email');
      const passwordInput = document.getElementById('login-password');
      const submitBtn = document.getElementById('login-submit');
      const googleBtn = document.getElementById('google-login');
      const errorBox = document.getElementById('login-error');

      function setError(message) {
        errorBox.textContent = String(message || '');
      }

      function setBusy(next) {
        const busy = Boolean(next);
        submitBtn.disabled = busy;
        googleBtn.disabled = busy;
        submitBtn.textContent = busy ? 'Signing in...' : 'Login';
      }

      function getNextPath(auth) {
        const params = new URLSearchParams(window.location.search || '');
        const raw = String(params.get('next') || '');
        if (!raw) return '';
        return typeof auth.normalizeNextPath === 'function' ? auth.normalizeNextPath(raw) : '';
      }

      async function init() {
        const auth = window.ResumeAuth;
        if (!auth) {
          setError('Authentication module failed to load.');
          return;
        }

        const nextPath = getNextPath(auth);
        const redirectAfterAuth = () => {
          if (nextPath) {
            window.location.replace(nextPath);
            return;
          }
          window.location.replace(auth.getAppHref('profile.html'));
        };

        try {
          const session = await auth.getSession();
          if (session && session.user) {
            await auth.ensureProfile({ user: session.user });
            redirectAfterAuth();
            return;
          }
        } catch (_e) {}

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          setError('');

          const email = String(emailInput.value || '').trim();
          const password = String(passwordInput.value || '');
          if (!email || !password) {
            setError('Enter your email and password.');
            return;
          }

          setBusy(true);
          try {
            const sb = await auth.getClient();
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) throw error;
            if (!data || !data.user) {
              throw new Error('Login failed. Please try again.');
            }

            await auth.ensureProfile({ user: data.user });
            redirectAfterAuth();
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
          } finally {
            setBusy(false);
          }
        });

        googleBtn.addEventListener('click', async () => {
          setError('');
          setBusy(true);
          try {
            const sb = await auth.getClient();
            const { error } = await sb.auth.signInWithOAuth({
              provider: 'google',
              options: {
                redirectTo: auth.getOAuthRedirectTo(nextPath)
              }
            });
            if (error) throw error;
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setBusy(false);
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
  <script src="js/header.js?v=9"></script>
  <script src="js/footer.js?v=20"></script>
  <script src="js/site-shell.js?v=6"></script>
</body>

</html>
